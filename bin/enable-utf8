#!/usr/bin/env bash

PROGNAME="${BASH_SOURCE[0]}"
HERE="$(cd "$(dirname "$PROGNAME")" &>/dev/null && pwd)"
READIES=$(cd $HERE/.. && pwd)
. $READIES/shibumi/defs

create_utf8_profile_script() {
	local profile_d=`get_profile_d`
	if [[ -n $1 ]]; then
		local language="$__language"
	fi
	cat <<-EOF > $profile_d/utf8.sh
		export LANG="${__language}.${__utf8}"
		export LC_ALL="${__language}.${__utf8}"
		EOF
	if [[ -z $LANGUAGE ]]; then
		cat <<-EOF >> $profile_d/utf8.sh
			export LANGUAGE="${__language}"
			EOF
	fi
}

__language="$(echo "$LANGUAGE" | cut -f1 -d.)"

export __language=${__language:-en_US}
export __utf8=utf8

if is_command apt-get; then
	if ! locale -a 2>/dev/null | grep "${__language}\.${__utf8}" &> /dev/null; then
		if ! dpkg -l locales locale-gen &> /dev/null; then
			runn apt-get -qq update
			runn apt-get install --fix-missing -q -y locales
		fi
		runn locale-gen --purge ${__language}.${__utf8}
		runn dpkg-reconfigure -f noninteractive locales
	fi
	create_utf8_profile_script

elif is_command yum; then
	EPEL=$(source /etc/os-release; echo $VERSION_ID;)
	if [[ $EPEL == 8 ]]; then
		runn dnf install -y langpacks-en glibc-all-langpacks
	elif [[ -f /etc/yum.conf && -n $(grep '^override_install_langs=' /etc/yum.conf) ]]; then
		runn @ <<-EOF
			sed -i 's/^\(override_install_langs=\)/# \1/' /etc/yum.conf
			EOF
		runn "yum reinstall -y glibc-common || yum install -y glibc-common"
	fi
	create_utf8_profile_script

elif is_command brew; then
	export __utf8=UTF-8
	if ! locale -a 2>/dev/null | grep "${__language}\.${__utf8}" &> /dev/null; then
		create_utf8_profile_script
	else
		export __language="C"
		create_utf8_profile_script
	fi

else
	if ! locale -a 2>/dev/null | grep "${__language}\.${__utf8}" &> /dev/null; then
		create_utf8_profile_script
	else
		export __language="C"
		create_utf8_profile_script
	fi
fi
