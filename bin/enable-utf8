#!/usr/bin/env bash

PROGNAME="${BASH_SOURCE[0]}"
HERE="$(cd "$(dirname "$PROGNAME")" &>/dev/null && pwd)"
READIES=$(cd $HERE/.. && pwd)
. $READIES/shibumi/defs

create_utf8_profile_script() {
	local profile_d=`get_profile_d`
	# [[ -f $profile_d/utf8.sh ]] && return
	if [[ -n $1 ]]; then
		local language=$1
	else
		local language="$(echo "$LANGUAGE" | cut -f1 -d:)"
	fi
	language="${language:-C}"
	cat <<-EOF > $profile_d/utf8.sh
		export LANG="${language}.${__UTF8}"
		# export LANGUAGE="${language}"
		export LC_ALL="${language}.${__UTF8}"
		EOF
}

export __UTF8=utf8
export __language=en_US

if is_command apt-get; then
	# if export LANG="en_US.${__UTF8}" 2>&1 | grep warning &> /dev/null; then
	if ! locale -a 2>/dev/null | grep 'en_US.utf8' &> /dev/null; then
		if ! dpkg -l locales locale-gen &> /dev/null; then
			runn apt-get -qq update
			runn apt-get install --fix-missing -q -y locales
		fi
		runn locale-gen --purge en_US.${__UTF8}
		runn dpkg-reconfigure -f noninteractive locales
	fi
	create_utf8_profile_script

elif is_command yum; then
	EPEL=$(source /etc/os-release; echo $VERSION_ID;)
	if [[ $EPEL == 8 ]]; then
		runn dnf install -y langpacks-en glibc-all-langpacks
	elif [[ -f /etc/yum.conf && -n $(grep '^override_install_langs=' /etc/yum.conf) ]]; then
		runn @ <<-EOF
			sed -i 's/^\(override_install_langs=\)/# \1/' /etc/yum.conf
			EOF
		runn "yum reinstall -y glibc-common || yum install -y glibc-common"
	fi
	create_utf8_profile_script

elif is_command brew; then
	export __UTF8=UTF-8
	if ! locale -a 2>/dev/null | grep 'en_US.UTF-8' &> /dev/null; then
		create_utf8_profile_script
	fi

else
	create_utf8_profile_script "C"
fi
